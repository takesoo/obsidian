---
tags:
  - 設計
---
##  logレベル
| 種類     | 意味                   |
| ------ | -------------------- |
| EMERG  | システムの利用が不可能          |
| ALERT  | アクションをすぐに起こさなければならない |
| CRIT   | 致命的な欠落がある状態          |
| ERROR  | エラーが起こっている状態         |
| WARN   | 警告されている状態            |
| NOTICE | 正常ではあるが重要な状態         |
| INFO   | 情報メッセージ              |
| DEBUG  | システムの動作に関する情報        |
## 出力先
- logファイル
- [[標準出力]]
- 外部ログ管理ツール（[[CloudWatch]]とか）
- 外部システム（Slackとか）
## フォーマット
| 項目      | 内容             | 備考                            |
| ------- | -------------- | ----------------------------- |
| 時間      | ログを記録した時間      | 年月日時分秒ミリ秒。最低でもミリ秒単位で出力する必要がある |
| イベントID  | イベントのID        | 一連のイベントをトレースするために必要           |
| ログレベル   | ログのレベル         | INFO、ERRORなど                  |
| リクエスト対象 | どこに対してのリクエストか  | URLなど                         |
| ユーザー情報  | リクエストしたユーザーの情報 | ユーザーIDやIPアドレスなど               |
| 処理対象    | 何に対する処理を行ったか   | 処理を行ったリソースのIDなど               |
| 処理内容    | どのような処理を行ったか   | DELETE、PUT、GETなど              |
| 処理結果    | 処理を行った結果どうなったか | 成功、失敗、処理件数など                  |
| メッセージ   | その他、出力したい内容    | ログレベルがエラー以上の時にメッセージがあると望ましい   |
```log
[Error] Feb 21 12:32:23, 193.121.123, https-8080, Failed, client denied by server
```
## ログ設計のポイント
1. ログの使用用途は何か
	以下のいずれか
	- 外部からの不正アクセスの把握
	- 情報漏洩防止など内部統制
	- システムの利用状況の把握
2. ログの読者は誰か
	開発者、運用担当者、顧客企業の社員、etc
3. どのようなフォーマットにするか
	読者によって出力される情報の順番を変える。例えば、法務担当者が読者ならメッセージを前半に移動させるなど。
4. どのようなメッセージを入れるか
	エラーメッセージを出力する。読者が理解可能な書き方をする。
5. どのレベルを選択するか
	使用用途に合わせてログレベルを選択する
## ログ出力の注意点
- 時間や日付でログファイルをローテートする
	- `/etc/logrotate.d/sample-service`
- 構造化ロギングを導入する
- 時刻同期とタイムゾーンの設定
- ログローテーションの基本設定を確認する
- Dockerの場合はlog driverでコンテナ外に出力する
- [[CDN]]や[[リバースプロキシサーバー]]を利用する場合、クライアントのIPアドレスは別のヘッダーフィールドが保持しているので、それがログに出力されるようにする