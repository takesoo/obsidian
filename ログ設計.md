---
tags:
  - 設計
---
## ログをとる目的
|主な目的|説明|
|---|---|
|障害対応|システムに問題が発生した時に、「何があったか」を知るためにある。|
|セキュリティ監査|不正アクセスがあったときの調査や、ISMS監査で証跡ログを提出するなど|
|ユーザー行動分析|どの機能がどれだけ使われているかなどの利用状況把握|
|パフォーマンス改善|どの処理が時間を要しているか探る|
## ログの種類
| 種類         | 説明                                     |
| ---------- | -------------------------------------- |
| アプリケーションログ | 特定のソフトウェアアプリケーション内での動作や処理に関する記録        |
| システムログ     | OSやサーバーの稼働状況、起動・シャットダウン情報などを記録         |
| セキュリティログ   | アクセス試行、認証成功/失敗、権限変更などのセキュリティ関連イベント     |
| ネットワークログ   | ネットワークトラフィック、接続、ルーティング情報               |
| トランザクションログ | データベースの変更履歴、トランザクション処理状況               |
| イベントログ     | システム全体のイベント記録（Windows Event Logなど）     |
| 監査ログ       | コンプライアンスやポリシー遵守の検証用の記録                 |
| アクセスログ     | Webサーバーなどへのアクセス記録（訪問者のIP、時間、リクエスト内容など） |
| パフォーマンスログ  | システムリソース使用状況、応答時間などのパフォーマンス指標          |
| デバッグログ     | 開発・テスト中の詳細な動作情報                        |
| 変更ログ       | システム設定や環境の変更履歴                         |

##  ログレベル
ログの重要性(Severity)の判別のため
定義はプロトコルやロガーによって異なる

| tool                          | levels                                                                   |
| ----------------------------- | ------------------------------------------------------------------------ |
| Log4j, Lambdaのapplication log | TRACE, DEBUG, INFO, WARN, ERROR, FATAL                                   |
| SLF4J/Logback                 | TRACE, DEBUG, INFO, WARN, ERROR                                          |
| Python logging                | DEBUG, INFO, WARNING, ERROR, CRITICAL                                    |
| Syslog (RFC5424), winston     | Emergency, Alert, Critical, Error, Warning, Notice, Informational, Debug |
## 出力先
- logファイル
- [[標準出力]]
- 外部ログ管理ツール（[[CloudWatch]]とか）
- 外部システム（Slackとか）
## フォーマット
| 項目      | 内容             | 備考                            |
| ------- | -------------- | ----------------------------- |
| 時間      | ログを記録した時間      | 年月日時分秒ミリ秒。最低でもミリ秒単位で出力する必要がある |
| イベントID  | イベントのID        | 一連のイベントをトレースするために必要           |
| ログレベル   | ログのレベル         | INFO、ERRORなど                  |
| リクエスト対象 | どこに対してのリクエストか  | URLなど                         |
| ユーザー情報  | リクエストしたユーザーの情報 | ユーザーIDやIPアドレスなど               |
| 処理対象    | 何に対する処理を行ったか   | 処理を行ったリソースのIDなど               |
| 処理内容    | どのような処理を行ったか   | DELETE、PUT、GETなど              |
| 処理結果    | 処理を行った結果どうなったか | 成功、失敗、処理件数など                  |
| メッセージ   | その他、出力したい内容    | ログレベルがエラー以上の時にメッセージがあると望ましい   |
```log
[Error] Feb 21 12:32:23, 193.121.123, https-8080, Failed, client denied by server
```
## ログ出力の注意点
- 時間や日付でログファイルをローテートする
	- `/etc/logrotate.d/sample-service`
- 構造化ロギングを導入する
- 時刻同期とタイムゾーンの設定
- ログローテーションの基本設定を確認する
- Dockerの場合はlog driverでコンテナ外に出力する
- [[CDN]]や[[リバースプロキシサーバー]]を利用する場合、クライアントのIPアドレスは別のヘッダーフィールドが保持しているので、それがログに出力されるようにする
- 機密情報はマスキングする