---
aliases:
  - pt-osc
---
## what
- 主に[[MySQL]]向けに作られた運用ツール群[[percona]]の中の１ツール
- テーブルへの読み書きを維持したまま（ロックなしで）`ALTER TABLE`を実行できる
## why
- ALTER操作はテーブルに対して共有ロックを取得するので、テーブルのレコード数が多い場合はその間書き込みプロセスが待ち状態になりサービスが停止してしまう
- [[MySQL]]5.6からは[[オンラインDDL]]ができるようになったが、すべてのALTER操作に対応できるわけではない
### pt-oscの処理の流れ
1. 旧テーブルと同じスキーマ構造をした、新テーブルを作る
2. 新テーブルにalter tableを適用
3. トリガーを3つ作成し、旧テーブルのinsert/update/deleteが新テーブルに反映されるようにする
4. 旧テーブルのレコードを新テーブルにコピー
5. 新旧テーブルを入れ替え(rename)
6. 旧テーブルの削除
7. 3で作ったトリガーを削除
この処理の流れによって旧テーブルのI/Oを維持したまま`ALTER TABLE`できる
## how

## デメリット
- 実行中はデータコピーやトリガー処理が走るので、ディスクI/O, CPUに負荷がかかる
- テーブルコピーできるだけのディスク容量を確保する必要がある
- データコピーのタイミングによってはデッドロックの可能性がある
- トリガー作成・削除、rename tableのタイミングにはテーブルロックを取得する