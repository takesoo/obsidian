---
tags:
  - AWS/CDK
  - ベストプラクティス
---
## CDKの哲学
- AWS CDKは、アプリケーション全体をコードで定義し、ソースリポジトリへのプッシュによってのみデプロイされたアプリケーションへの変更をするというモデルを可能にしています。
- 別々のリポジトリとCI/CDで管理されがちなインフラ構成とアプリケーションコードなどをAWS CDKによって単一リポジトリで管理することが可能になる。

## 組織での取り組み
- AWS CDKやマイクロサービスの継続的なデプロイメントモデルへの移行は難しいため、社内の他のメンバーがAWS CDKを使い始める際のトレーニングや指導を担当する専門家チームを設置することが最善の方法です。私たちは、すべての中規模および大規模な組織が、アプリケーションの開発とデプロイに関するメンター、トレーナー、および会社のポリシーの保護者として機能する[クラウドセンターオブエクセレンス](https://aws.amazon.com/blogs/enterprise-strategy/tag/ccoe/) (CCoE) を立ち上げることを強くお勧めします。
- [[AWSマルチアカウント|マルチアカウント]]

## コードを管理するためのベストプラクティス
- シンプルな構成から始めて、必要に応じて複雑な構成に変更
- １パッケージ構成から始めて、他のアプリケーションで再利用されるところは別のパッケージに切り出す。
- １リポジトリ１デプロイメントパイプライン
- コードのライフサイクルやチームの所有権に応じてリポジトリを分割する
- インフラストラクチャコードとアプリケーションコードを同じパッケージにする

## Constructライブラリのベストプラクティス
- StackではなくConstructでアプリをモデル化する
- 環境変数ではなく、API（プロパティ、メソッド）で設定する
	- 機密情報は[[AWS Secrets Manager]]？
- ユニットテストを書く
- ステートフルリソースのスコープと論理IDを変更しない
- L2Constructを継承して会社のセキュリティ仕様を実装しない
	- [[SCP]]や[[permission bundary]]で対応する

## AWS CDK アプリケーションのベストプラクティス
- CloudFormationの制御構文は使わない
- 新規登録されるリソース名を使用する
	- e.g. `table.tableName`
- デプロイ要件に応じて、アプリケーションのStageを複数のStackに分割する
	- 一般的にはできるだけ多くのリソースを同じStackに入れるのが簡単
	- ステートフルなリソース（DBなど）はステートレスなリソースから分離しておくと良い。
	- ステートフルリソースのあるStackは削除保護をオンにしておく
	- ステートフルなリソースはConstractの中には入れない。名前が変更されてデータを喪失する可能性があるので。
- `cdk.context.json`をコミットして、外部的な要因で合成結果が変わってしまうことを避ける
- AWS CDKでロールとセキュリティグループを管理できるようにする
- 全てのStageをコードでモデル化する
- 全てを測定する

---
[AWS CDKでクラウドアプリケーションを開発するためのベストプラクティス | Amazon Web Services ブログ](https://aws.amazon.com/jp/blogs/news/best-practices-for-developing-cloud-applications-with-aws-cdk/)