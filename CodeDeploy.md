---
tags:
  - AWS
---
## what
- フルマネージドな自動デプロイサービス
- EC2インスタンス、オンプレミスサーバー、Lambda関数、ECSサービスへのデプロイが可能
- ブルー/グリーンデプロイメントやローリング更新をサポート
- エラーを検知すると自動でロールバック
### 基本構造
```
アプリケーション（Application）
└── デプロイグループ（Deploy Group）
    └── デプロイメント（Deployment）
```
- アプリケーション：デプロイしたいソフトウェアの単位（例：Webアプリケーション、APIサーバー、モバイルアプリのバックエンド）
	- コンピューティングプラットフォーム：EC2/オンプレミス, Lambda, ECS
- デプロイグループ：「どのサーバーに」「どうやって」デプロイするかの設定
	- 対象サーバーの指定：EC2インスタンスなど
	- デプロイ方式：
		- In-Place: 一度に全部
		- Blue/Green
	- デプロイ設定：
		- EC2/オンプレミス
			- One-at-a-time: 一つずつデプロイ
			- \[Custom]
			- Half-at-a-time: 半分ずつデプロイ
			- All-at-a-once: 一度に全部デプロイ
		- Lambda, ECS
			- Linear: 徐々にv2の比率を増やしていく
			- Canary: まず少しだけv2をデプロイし、問題なければ全部デプロイの2段構成
			- All-at-once: 一度に全部デプロイ
	- リビジョン
		- EC2: ソースコード、webページ、スクリプトなどとAppSpecファイルをまとめたアーカイブ
		- Lambda：Lambdaデプロイ用のAppSpecファイル
		- ECS：ECSデプロイ用のAppSpecファイル
	- ターゲットリビジョン
		- デプロイグループへデプロイする対象のリビジョン
		- たとえば、リリース対象となるGitHubリポジトリのバージョン
	- 環境の定義：本番、ステージング
	- サービスロール
		- CodeDeployに付与するIAMロール
		- AWS管理ポリシーが用意されている
	- IAMインスタンスプロファイル
		- EC2インスタンスに付与するIAMロール
		- S3から配布物を取得できるようにする

### appspec.yml
- デプロイ時にサーバー上で何をするかの手順書
- 構成要素
	- Resouces: デプロイする先とデプロイ方式の指定
	- Hooks: デプロイの各ステップの間に差し込む処理
## how
- EC2/オンプレミスの場合
	- アプリケーション、デプロイグループ、アプリケーションリビジョン、デプロイメントの作成
	- サービスロールの指定
	- デプロイ方式の指定
	- CodeDeployエージェントのインストール
	- appspec.ymlファイルをルートディレクトリに配置
- Lambda関数の場合
	- 関数重み付けエイリアス
	- 
- ECSの場合
	- blue/greenデプロイ


|                 | EC2                                       | オンプレミス                                    | Lambda                                                       | ECS                                          |
| --------------- | ----------------------------------------- | ----------------------------------------- | ------------------------------------------------------------ | -------------------------------------------- |
| 対象/方式           | In-Place, Blue/Green                      | In-Place                                  | Canary, Linear, All-at-once<br>（関数重み付けエイリアスによるトラフィックの段階的シフト） | 新旧タスクセットとロードバランサーのターゲットグループ切り替えによるBlue/Green |
| デプロイ設定          | AllAtOnce, HalfAtOnce, OneAtATime, Custom | AllAtOnce, HalfAtOnce, OneAtATime, Custom | Canary, Linear, All-at-once                                  | Canary, Linear, All-at-once                  |
| AppSpec（設定ファイル） |                                           |                                           |                                                              |                                              |
| 必須コンポーネント       | CodeDeployAgent                           | CodeDeployAgent                           |                                                              |                                              |
| ロールバック          | フック失敗やヘルス不良で自動ロールバック                      | フック失敗やヘルス不良で自動ロールバック                      | バリデーションフック失敗やCloudWatchアラームによるロールバック                         | バリデーション/アラームで中止・ロールバック                       |
