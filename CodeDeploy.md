---
tags:
  - AWS
---
## what
- フルマネージドな自動デプロイサービス
- EC2インスタンス、オンプレミスサーバー、Lambda関数、ECSサービスへのデプロイが可能
- ブルー/グリーンデプロイメントやローリング更新をサポート
- エラーを検知すると自動でロールバック
### 基本構造
```
アプリケーション（Application）
└── デプロイグループ（Deploy Group）
    └── デプロイメント（Deployment）
```
- アプリケーション：デプロイしたいソフトウェアの単位（例：Webアプリケーション、APIサーバー、モバイルアプリのバックエンド）
	- コンピューティングプラットフォーム：EC2/オンプレミス, Lambda, ECS
- デプロイグループ：「どのサーバーに」「どうやって」デプロイするかの設定
	- 対象サーバーの指定：EC2インスタンスなど
	- デプロイ方式：
		- In-Place: 一度に全部
		- Blue/Green
	- デプロイ設定：
		- EC2/オンプレミス
			- One-at-a-time: 一つずつデプロイ
			- \[Custom]
			- Half-at-a-time: 半分ずつデプロイ
			- All-at-a-once: 一度に全部デプロイ
		- Lambda, ECS
			- Linear: 徐々にv2の比率を増やしていく
			- Canary: まず少しだけv2をデプロイし、問題なければ全部デプロイの2段構成
			- All-at-once: 一度に全部デプロイ
	- リビジョン
		- EC2: ソースコード、webページ、スクリプトなどとAppSpecファイルをまとめたアーカイブ
		- Lambda：Lambdaデプロイ用のAppSpecファイル
		- ECS：ECSデプロイ用のAppSpecファイル
	- ターゲットリビジョン
		- デプロイグループへデプロイする対象のリビジョン
		- たとえば、リリース対象となるGitHubリポジトリのバージョン
	- 環境の定義：本番、ステージング
	- サービスロール
		- CodeDeployに付与するIAMロール
		- EC2, Lambda, ECSへのアクセス許可
		- AWS管理ポリシーが用意されている
	- IAMインスタンスプロファイル
		- EC2インスタンスに付与するIAMロール
		- 配布物取得のためにS3へのアクセス許可

### appspec.yml
- デプロイ時にサーバー上で何をするかの手順書
- リビジョンのルートに配置する
- デプロイ先（EC2/オンプレミス、Lambda、ECS）によって記述内容が異なる
- 構成要素
	- Resouces: デプロイする先とデプロイ方式の指定
	- Hooks: デプロイの各ステップの間に差し込む処理
## how

|              | EC2                                                                          | オンプレミス                                                               | Lambda                                                                                   | ECS                                          |
| ------------ | ---------------------------------------------------------------------------- | -------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- | -------------------------------------------- |
| 対象/方式        | In-Place, Blue/Green                                                         | In-Place                                                             | Canary, Linear, All-at-once<br>（[[AWS Lambda#Lambdaエイリアス\|関数重み付けエイリアス]]によるトラフィックの段階的シフト） | 新旧タスクセットとロードバランサーのターゲットグループ切り替えによるBlue/Green |
| デプロイ設定       | AllAtOnce, HalfAtOnce, OneAtATime, Custom                                    | AllAtOnce, HalfAtOnce, OneAtATime, Custom                            | Canary, Linear, All-at-once                                                              | Canary, Linear, All-at-once                  |
| AppSpecの記述内容 | files, permissions, hooks                                                    | files, permissions, hooks                                            | 関数名、エイリアス、バリデーションフック                                                                     | サービス、タスク定義、ロードバランサーのターゲットグループ、フック            |
| 必須コンポーネント    | CodeDeployAgentをサーバーにインストール。<br>IAMインスタンスプロファイルの作成。<br>CodeDeployサービスロールの作成。 | CodeDeployAgentをサーバーにインストール。<br>EC2 IAM ロールの作成。CodeDeployサービスロールの作成。 |                                                                                          |                                              |
| ロールバックトリガー   | フック失敗<br>ヘルス不良                                                               | フック失敗<br>ヘルス不良                                                       | バリデーションフック失敗<br>CloudWatchアラーム発火                                                         | ヘルスチェック失敗<br>CloudWatchアラーム発火                |
