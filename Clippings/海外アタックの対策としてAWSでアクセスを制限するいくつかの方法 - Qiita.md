---
Created: Invalid date
URL: https://qiita.com/buntafujikawa/items/418363dfc335de053478
---
[![](https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-9f5428127621718a910c8b63951390ad.png?ixlib=rb-4.0.0&w=1200&mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTkxNiZ0eHQ9JUU2JUI1JUI3JUU1JUE0JTk2JUUzJTgyJUEyJUUzJTgyJUJGJUUzJTgzJTgzJUUzJTgyJUFGJUUzJTgxJUFFJUU1JUFGJUJFJUU3JUFEJTk2JUUzJTgxJUE4JUUzJTgxJTk3JUUzJTgxJUE2QVdTJUUzJTgxJUE3JUUzJTgyJUEyJUUzJTgyJUFGJUUzJTgyJUJCJUUzJTgyJUI5JUUzJTgyJTkyJUU1JTg4JUI2JUU5JTk5JTkwJUUzJTgxJTk5JUUzJTgyJThCJUUzJTgxJTg0JUUzJTgxJThGJUUzJTgxJUE0JUUzJTgxJThCJUUzJTgxJUFFJUU2JTk2JUI5JUU2JUIzJTk1JnR4dC1jb2xvcj0lMjMyMTIxMjEmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTYmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWxlZnQlMkN0b3Amcz1jYzBiYzQxMjdiYzgyNmNhYTA1NGIyN2E4ZDQzMzI5MA&mark-x=142&mark-y=112&blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTYxNiZ0eHQ9JTQwYnVudGFmdWppa2F3YSZ0eHQtY29sb3I9JTIzMjEyMTIxJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTM2JnR4dC1hbGlnbj1sZWZ0JTJDdG9wJnM9ZjNjOGI0ZDIxMmM5Y2Y0ZmNhMzE0Njc4Njc5M2ZkNjM&blend-x=142&blend-y=491&blend-mode=normal&s=bcd6c162949d98f54a4771e834d86610)](https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-9f5428127621718a910c8b63951390ad.png?ixlib=rb-4.0.0&w=1200&mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTkxNiZ0eHQ9JUU2JUI1JUI3JUU1JUE0JTk2JUUzJTgyJUEyJUUzJTgyJUJGJUUzJTgzJTgzJUUzJTgyJUFGJUUzJTgxJUFFJUU1JUFGJUJFJUU3JUFEJTk2JUUzJTgxJUE4JUUzJTgxJTk3JUUzJTgxJUE2QVdTJUUzJTgxJUE3JUUzJTgyJUEyJUUzJTgyJUFGJUUzJTgyJUJCJUUzJTgyJUI5JUUzJTgyJTkyJUU1JTg4JUI2JUU5JTk5JTkwJUUzJTgxJTk5JUUzJTgyJThCJUUzJTgxJTg0JUUzJTgxJThGJUUzJTgxJUE0JUUzJTgxJThCJUUzJTgxJUFFJUU2JTk2JUI5JUU2JUIzJTk1JnR4dC1jb2xvcj0lMjMyMTIxMjEmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTYmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWxlZnQlMkN0b3Amcz1jYzBiYzQxMjdiYzgyNmNhYTA1NGIyN2E4ZDQzMzI5MA&mark-x=142&mark-y=112&blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTYxNiZ0eHQ9JTQwYnVudGFmdWppa2F3YSZ0eHQtY29sb3I9JTIzMjEyMTIxJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTM2JnR4dC1hbGlnbj1sZWZ0JTJDdG9wJnM9ZjNjOGI0ZDIxMmM5Y2Y0ZmNhMzE0Njc4Njc5M2ZkNjM&blend-x=142&blend-y=491&blend-mode=normal&s=bcd6c162949d98f54a4771e834d86610)

---

セキュリティの対策としてIP制限などを行っており、AWSのサポートに問い合わせたり調べたりとしているので、少しでも同じ状況の人の参考になれば良いなと思いまとめました。  
この記事で具体的にどのように設定していくかというよりも、全体的にどんな選択肢があるのかがわかるようになれば良いなと思います。

## その前に

まずは要件を確認し、海外からのアクセスは全て遮断して良いのか、国単位なのか、連携しているシステムで海外IPのものは存在するのかなどを確認すると良いかなと思います。  
事前に情報がまとまっている方が、無駄な情報を集めないで済みます。

## AWSで海外からのアクセス制限を行う時にできること

### セキュリティグループ

**インスタンス単位**で**ホワイトリスト型**のIP制限ができるので、特定のIPからしかアクセスを許可していないシステムには使用できます。  
社内IPのみとか連携しているシステムのみみたいな感じで指定するしかないので、不特定多数のユーザーが使うBtoCのサービスには使えないです。

### ネットワークACL

**サブネット単位**で**ブラックリスト型**のIP制限を設定することができるので、似たようなIPからアタックがきている場合にはこちらで対応が可能です。  
申請をしないと20個までしかルールを追加できないです。(最新の情報は下記)[Amazon VPC の制限](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/amazon-vpc-limits.html)

サブネットマスクの指定が可能なので、下記のipからアタックがきていた場合には、 `5.8.37.0/24` のルールを1つ設定すれば対応が可能です。

ただ、不正をするユーザーは基本的にはIPを変えてくるので、こちらでは一時的な対応にしかならないと思います。

### Route53

個別のIPを指定しての制限はできないが、**地理情報に基づいて制限**をかけることが可能です。  
そのため日本からのアクセスに絞る場合にはこれが一番楽だと思います。精度が100%ではないです。

### セキュリティオートメーション案

CloudFormation を利用したソリューション(これは使ったことがないので詳しくわからないです。。)  
詳しくはクラスメソッドさんの記事を参考にしてください。[[レポート]AWS によるセキュリティ・オートメーションの実践 \#AWSSummit](https://dev.classmethod.jp/cloud/aws/aws-summit-tokyo-2018-secope/)

### WAF

これは一番自由度が高く使いやすいと思います。その代わり有料です。  
wafでできそうなことを簡単に書いてみます。

### マネージドルールの適用

一部の海外IPからは許可したいみたいな時は、下記のようにルールを作成して、順番を指定すれば実現できます。  
このように複数のルールとその適用順番で柔軟に対応ができるのが良いポイントです。

IP以外にも指定できる条件が多いです。[AWS WAF、AWS Shield、AWS Firewall Manager の概要](https://docs.aws.amazon.com/ja_jp/waf/latest/developerguide/what-is-aws-waf.html)

> 指定した条件を使用した、ウェブ攻撃に対する追加の保護。条件を定義するには、以下のようなウェブリクエストのプロパティを使用します。 リクエストの発生元の IP アドレス. リクエスト送信元の国。 リクエストヘッダーの値. リクエストに含まれる文字列 (正規表現パターンと一致する特定の 1 つ以上の文字列)。 リクエストの長さ. 悪意のある可能性がある SQL コード (SQL インジェクション) の有無。 悪意のある可能性があるスクリプト (クロスサイトスクリプティング) の有無。

### レートベースルール

条件に一致したリクエストが5分間で任意の数（2000以上）発生した場合に、送信元をブラックリストに登録することなどができます。

### レピュテーションの悪いIPをブラックリストに追加する(Lambdaとの組み合わせ)

こちらの記事で紹介されていましたが、Lambdaで定期的に取得して、ブラックリストに追加するということができるそうです。  
こちらも検討したことがありますが、実際にアタックに使われていたIPが全く含まれておらず結局使わなかったです。[[youcanuseawswafawebapplicationfirewalltohelpprotectyourwebapplicationsf]]

### 参考情報

### wafのログは3時間しか残らない

wafに関してはどのリクエストが許可されてどのリクエストが拒否されたかログが残るようになっているが、過去3時間分しか残らないようになっています。  
そのためS3に保存する方法はよく記事で見かけます。[AWS WAF Full Log を S3 に出力する](https://www.wafcharm.com/blog/aws-waf-full-log-s3-output-jp/)

### 日本から使っているユーザーでも、IPアドレスが海外のものになってしまうこともある

### リキャプチャなどの対策もある